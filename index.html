<!doctype html>
<html>

<head>
    <title>Hi there!</title>

    <style>
        .u-push-left {
            padding-left: 16px;
        }
        
        .u-push-right {
            padding-right: 32px;
        }
        
        .u-force--inline-block {
            display: inline-block;
        }
        
        .c-term {
            font-family: monospace;
            font-size: 5vw;
        }
        
        .c-term__command {
            border: 0;
            outline: none;
            font-family: monospace;
            font-size: 5vw;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="//code.jquery.com/jquery-3.1.1.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenMax.min.js"></script>

    <script src="mithril.js"></script>

    <script>
        const Direction = {
            In: 'in',
            Out: 'out'
        };

        const messages = m.prop([
            { direction: Direction.Out, text: 'Welcome!' }
        ]);

        const prompt = m.prop('>');
        const command = m.prop('');
        const banner = m.prop('basp.github.io (c) 2016 [experimental version]');

        const Term = {
            controller: function () {
                return {
                    messages: messages,
                    prompt: prompt,
                    command: command,
                    banner: banner,
                    exec: function (e) {
                        var input = e.target['value'], output;                  

                        try {
                            // This naive `eval` will not work in such 
                            // examples as "{ foo: 'quux', bar: 'frotz' }".
                            // `q = { foo: 'quux', bar: 'frotz' }` *does* work
                            // however. Wat?
                            //
                            // https://www.destroyallsoftware.com/talks/wat
                            output = eval(input);
                        }
                        catch (ex) {
                            output = { 
                                // The type of `ex` is some weird *native*
                                // thing that we can't just `JSON.stringify`
                                // it seems.
                                error: ex.toString() 
                            };
                        }

                        messages().push({
                            direction: Direction.In,
                            text: input
                        });

                        messages().push({
                            direction: Direction.Out,
                            text: JSON.stringify(output)
                        });

                        // This is quite hacky but it was the only way
                        // to get the desired behavior on Chrome. 
                        // 
                        // Apparently it is *too* fast so it tries to set
                        // focus even before redrawing the element (it 
                        // only happens when messages are pushed).
                        //
                        // To be fair to Mithril, this is a bit of an
                        // uncommon use case and it's a browser specific 
                        // timing bug that.
                        //
                        // And still I have this nagging gut feeling that 
                        // I'm just doing it wrong.
                        setTimeout(() => {
                            // I also hate involving jQuery in this hack
                            // but it still *is* the most readable way to
                            // get to a DOM element if you have to fudge it.
                            $('.js-refocus-on-input').focus();
                        }, 0);
                    }
                };
            },
 
            view: function (ctrl) {
                const messages = ctrl.messages().map(msg => m('div', {
                    class: 'c-term___message'
                }, [                  
                    m('span', {
                        class: 'u-force--inline-block u-push-right'
                    },
                    msg.direction === Direction.In ? '>' : '<'),
                    m('span', msg.text)
                ]));
                
                const prompt = m('div', [
                    m('span', { class: 'u-force--inline-block u-push-right' }, ctrl.prompt()),
                    m('input', {
                        class: 'js-refocus-on-input c-term__command',
                        autofocus: true,
                        type: 'text',
                        onchange: ctrl.exec
                    })
                ]);

                const banner = m('div', { class: 'c-banner' }, ctrl.banner());

                return m('div', { class: 'c-term'}, [
                    banner,
                    messages,
                    prompt
                ]);
            }
        };

        $(function () {
            const root = document.getElementById('root'); 
            m.mount(root, Term);
        });
    </script>
</body>

</html>