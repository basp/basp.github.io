<!doctype html>
<html>

<head>
    <title>Hi there!</title>

    <style>
        /*
        .u-force--inline-block {
            display: inline-block;
        }

        .u-force--one {
            width: 5vw;
        }
        
        .c-term {
            font-family: monospace;
            font-size: 3vw;
        }

        .c-term__command {
            border: 0;
            outline: none;
            font-family: monospace;
            font-size: 3vw;
        }
        */
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="//code.jquery.com/jquery-3.1.1.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenMax.min.js"></script>

    <script src="mithril.js"></script>

    <script>
        const Direction = {
            In: 'in',
            Out: 'out'
        };

        const KeyCode = {
            Up: 38,
            Down: 40
        };

        const prompt = m.prop('>');
        const banner = m.prop('basp.github.io (c) 2016 [experimental version]');
        const user = m.prop('guest');

        const messages = m.prop([
            { direction: Direction.Out, text: `Welcome ${user()}` }
        ]);

        const input = $('.js-refocus-on-input');

        const Term = {
            controller: function () {
                return {
                    messages: messages,
                    prompt: prompt,
                    banner: banner,
                    exec: function (e) {
                        var input = e.target['value'], output;                  

                        try {
                            output = eval(input);
                        }
                        catch (ex) {
                            output = { 
                                // The type of `ex` is some weird *native*
                                // thing that we can't just `JSON.stringify`
                                // it seems.
                                error: ex.toString() 
                            };
                        }

                        messages().push({
                            direction: Direction.In,
                            text: input
                        });

                        messages().push({
                            direction: Direction.Out,
                            text: JSON.stringify(output)
                        });

                        setTimeout(() => {
                            $('.js-refocus-on-input').focus();
                        }, 0);
                    }
                };
            },
 
            view: function (ctrl) {
                const messages = ctrl.messages().map(msg => m('div', {
                    class: 'c-term__message'
                }, [                  
                    m('span', {
                        class: 'u-force--inline-block u-force--one'
                    },
                    msg.direction === Direction.In ? '>' : '<Â·'),
                    m('span', msg.text)
                ]));
                
                const prompt = m('div', [
                    m('span', { class: 'u-force--inline-block u-force--one' }, ctrl.prompt()),
                    m('input', {
                        class: 'js-refocus-on-input c-term__command',
                        autofocus: true,
                        type: 'text',
                        onkeydown: function (e) {
                            if (e.keyCode === KeyCode.Up) {
                                e.preventDefault();
                                setTimeout(() => {
                                    $('.js-refocus-on-input')
                                        .focus()
                                        .val('foo');                                                                        
                                });
                                return false;
                            }
                        },
                        onchange: ctrl.exec
                    })
                ]);

                const banner = m('div', { class: 'c-banner' }, ctrl.banner());

                return m('div', { class: 'c-term'}, [
                    banner,
                    messages,
                    prompt
                ]);
            }
        };

        $(function () {
            const root = document.getElementById('root'); 
            m.mount(root, Term);
        });
    </script>
</body>

</html>